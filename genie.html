<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotanika - The Dark Genie</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .genie-page {
            background: linear-gradient(135deg, #2c1810 0%, #8b0000 50%, #000000 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
            animation: eerieGlow 3s ease-in-out infinite alternate;
        }

        .backstory-page {
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }

        @keyframes eerieGlow {
            0% { background: linear-gradient(135deg, #2c1810 0%, #8b0000 50%, #000000 100%); }
            100% { background: linear-gradient(135deg, #1a0f0a 0%, #660000 50%, #1a1a1a 100%); }
        }

        .genie-container {
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid #8b0000;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(139, 0, 0, 0.5), inset 0 0 30px rgba(255, 0, 0, 0.1);
            position: relative;
            animation: sinisterPulse 2s ease-in-out infinite alternate;
        }

        @keyframes sinisterPulse {
            0% { box-shadow: 0 20px 60px rgba(139, 0, 0, 0.5), inset 0 0 30px rgba(255, 0, 0, 0.1); }
            100% { box-shadow: 0 25px 70px rgba(139, 0, 0, 0.7), inset 0 0 40px rgba(255, 0, 0, 0.2); }
        }

        .genie-title {
            font-size: 2.5rem;
            color: #ff4444;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 0 10px #8b0000, 0 0 20px #ff0000;
            animation: menacingGlow 1.5s ease-in-out infinite alternate;
        }

        @keyframes menacingGlow {
            0% { text-shadow: 0 0 10px #8b0000, 0 0 20px #ff0000; }
            100% { text-shadow: 0 0 15px #ff0000, 0 0 30px #ff4444, 0 0 40px #8b0000; }
        }

        .genie-subtitle {
            color: #cc6666;
            margin-bottom: 30px;
            font-size: 1.1rem;
            text-shadow: 0 0 5px #8b0000;
        }

        .rotanika-image {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #8b0000;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px #ff0000, inset 0 0 20px rgba(139, 0, 0, 0.3);
            animation: evilImagePulse 2s ease-in-out infinite alternate;
        }

        @keyframes evilImagePulse {
            0% { border-color: #8b0000; box-shadow: 0 0 20px #ff0000, inset 0 0 20px rgba(139, 0, 0, 0.3); }
            100% { border-color: #ff0000; box-shadow: 0 0 30px #ff4444, inset 0 0 30px rgba(255, 0, 0, 0.5); }
        }

        .rotanika-exploding {
            animation: explosion 5s ease-out forwards;
            filter: saturate(300%) contrast(200%);
        }

        @keyframes explosion {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.2) rotate(5deg); filter: brightness(300%) hue-rotate(180deg); }
            50% { transform: scale(0.8) rotate(-10deg); filter: brightness(500%) hue-rotate(360deg); }
            75% { transform: scale(1.5) rotate(15deg); filter: brightness(200%) contrast(300%); }
            100% { transform: scale(0) rotate(720deg); opacity: 0; filter: brightness(0%); }
        }

        /* Smoke overlay during explosion */
        .smoke-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .smoke-puff {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(200,200,200,0.6) 0%, rgba(180,180,180,0.4) 60%, rgba(160,160,160,0) 70%);
            border-radius: 50%;
            filter: blur(2px);
            animation: smokeRise 2.2s ease-out forwards;
        }
        @keyframes smokeRise {
            0% { transform: translateY(0) scale(1); opacity: 0.6; }
            100% { transform: translateY(-140px) scale(1.7); opacity: 0; }
        }

        .rotanika-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .speech-bubble {
            background: #1a1a1a;
            border: 2px solid #8b0000;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: inset 0 0 20px rgba(139, 0, 0, 0.3), 0 0 15px rgba(255, 0, 0, 0.2);
        }

        .speech-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #8b0000;
        }

        .speech-text {
            font-size: 1.1rem;
            color: #ff6666;
            line-height: 1.5;
            text-shadow: 0 0 5px #8b0000;
        }

        .chat-input-container {
            margin: 30px 0;
        }

        .chat-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #8b0000;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: #2a2a2a;
            color: #ff6666;
        }

        .chat-input:focus {
            border-color: #ff0000;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .chat-input::placeholder {
            color: #cc6666;
        }

        .hint-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ffc107;
            color: #333;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .hint-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        .hint-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .hint-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .hint-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .hint-close:hover {
            color: #333;
        }

        .hint-content {
            margin-top: 20px;
        }

        .hint-content h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .hint-content p {
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .typing-indicator {
            display: none;
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }

        .typing-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .home-button:hover {
            background: #764ba2;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .backstory-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            position: relative;
        }

        .backstory-title {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .backstory-text {
            font-size: 1.2rem;
            color: #444;
            line-height: 1.6;
            margin-bottom: 30px;
            text-align: left;
        }

        .continue-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: gentlePulse 2s ease-in-out infinite alternate;
        }

        @keyframes gentlePulse {
            0% { transform: scale(1); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
            100% { transform: scale(1.05); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
        }

        .continue-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.6);
        }

        .hidden {
            display: none;
        }

        /* Mobile responsive fixes */
        @media (max-width: 768px) {
            .home-button, .hint-button {
                top: 10px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .home-button {
                left: 10px;
            }

            .hint-button {
                right: 10px;
            }

            .genie-title {
                font-size: 1.8rem;
                margin-top: 30px;
            }

            .genie-container {
                padding: 60px 20px 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Backstory Section -->
    <div class="backstory-page" id="backstoryPage">
        <div class="backstory-container">
            <a href="index.html" class="home-button">
                <i class="fas fa-home"></i>
            </a>

            <h1 class="backstory-title">📖 A Normal Day...</h1>

            <div class="backstory-text">
                <p>It was just another ordinary afternoon. You were browsing through your anniversary countdown website, enjoying the sweet memories and anticipating what surprises lay ahead.</p>

                <p>The mini-games had been fun so far, and you were excited to see what the fourth challenge would bring. You clicked on "Game 4" expecting another cute puzzle or riddle...</p>

                <p>But suddenly, the screen began to darken. The air around you grew cold and thick with an ominous presence. A sinister laugh echoed from nowhere and everywhere at once.</p>

                <p><strong>Something was very, very wrong...</strong></p>

                <p>Out of the swirling darkness, a malevolent figure began to materialize before you. This was no ordinary game anymore. You had awakened something ancient and evil.</p>

                <p style="text-align: center; font-weight: bold; color: #8b0000; font-size: 1.3rem;">The nightmare was about to begin...</p>
            </div>

            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
                <p style="color: #856404; margin: 0; font-size: 0.95rem;">
                    💻 <strong>Tip:</strong> For the best experience, we recommend playing this game on a computer!
                </p>
            </div>

            <div style="margin: 15px 0 20px; display:flex; align-items:center; justify-content:center; gap:10px;">
                <input type="checkbox" id="dontShowAgain" style="width:18px; height:18px;">
                <label for="dontShowAgain" style="color:#444; font-size:0.95rem;">Don't show this again</label>
            </div>
            <button class="continue-button" onclick="startGenieEncounter()">
                <i class="fas fa-forward"></i> Continue into the Darkness...
            </button>
        </div>
    </div>

    <!-- Evil Genie Section (Hidden initially) -->
    <div class="genie-page hidden" id="geniePage">
        <div class="genie-container">
            <a href="index.html" class="home-button">
                <i class="fas fa-home"></i>
            </a>

            <button class="hint-button" onclick="openHintModal()">
                <i class="fas fa-lightbulb"></i>
            </button>

            <h1 class="genie-title">👹 Rotanika the Dark</h1>
            <p class="genie-subtitle">The Evil Genie - Your worst nightmare has begun...</p>

            <div class="rotanika-image">
                <img id="rotanikaImg" src="images/rotanika-closed.jpg" alt="Rotanika" onload="console.log('Image loaded:', this.src)">
            </div>

            <div class="speech-bubble" id="speechBubble">
                <div class="speech-text" id="speechText">
                    <!-- Text will be populated by typewriter effect -->
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span class="typing-dots">Rotanika is thinking</span>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input"
                       placeholder="Try to find a way to defeat me... if you dare!"
                       onkeypress="handleKeyPress(event)">
            </div>
        </div>
    </div>

    <!-- Hint Modal -->
    <div id="hintModal" class="hint-modal">
        <div class="hint-modal-content">
            <span class="hint-close" onclick="closeHintModal()">&times;</span>
            <div class="hint-content">
                <h3>🔍 Web Navigation Hint</h3>

                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                    <p style="color: #856404; margin: 0; font-size: 0.9rem;">
                        💻 <strong>Note:</strong> Using a computer is recommended for this game!
                    </p>
                </div>

                <p><strong>Did you know?</strong> Websites are made up of many pages, just like a book has many chapters!</p>
                <p>Most websites work like this: if you're on <code>example.com/page1.html</code>, you can often navigate to other pages by changing the filename.</p>
                <p><strong>For example:</strong></p>

                <div style="margin: 20px 0; padding-left: 0;">
                    <p><code>example.com/home.html</code></p>
                    <p><code>example.com/about.html</code></p>
                    <p><code>example.com/contact.html</code></p>
                </div>

                <p style="margin-top: 25px;">💡 <strong>Tip:</strong> Once you figure out WHO can help you escape, try typing their name in the URL bar with <code>.html</code> at the end!</p>
                <p style="margin-top: 10px;">🎯 <strong>Hint:</strong> Think about people you know... maybe someone from Israel whose name starts with I?</p>
                <p>🕵️ Happy exploring!</p>
            </div>
        </div>
    </div>

    <audio id="rotanikaAudio" preload="auto" controls style="display: none;">
        <source src="audio/rotanika-voice.mp3" type="audio/mpeg">
        <source src="audio/rotanika-voice.ogg" type="audio/ogg">
    </audio>
    <audio id="victoryAudio" preload="auto" style="display:none;">
        <source src="audio/victory.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Evil welcome message
        const welcomeMessage = `Foolish mortal... You have stumbled into my domain, and now you are TRAPPED!
                    I am Rotanika... Akinator's EVIL cousin.
                    You don't even realize the dire situation you're in, do you?
                    There's only ONE person who might be able to help you escape... someone from far away, someone you know well... but I'll NEVER tell you their name! Mwahahaha!`;

        // Evil, menacing responses
        const yesResponses = [
            "Yes, pathetic mortal... and that knowledge will be your DOOM!",
            "Indeed! The dark forces confirm this truth... not that it will help you!",
            "Correct! The shadows whisper agreement... before they consume you!",
            "Yes, yes! But knowing this brings you closer to your destruction!",
            "The infernal realm vibrates with malicious confirmation!",
            "Absolutely! My evil essence tingles with wicked delight!",
            "By my horns! The demons cackle in agreement with your futile query!",
            "Verily! The cursed flames dance in mockery of your helplessness!",
            "Indeed, foolish one! The web of darkness weaves tighter around you!",
            "Correct! The ancient curses glow with malevolent approval!",
            "True! The spectral tormentors nod their ghastly heads!",
            "Most assuredly! The compass of despair points toward your suffering!",
            "Without doubt! The winds of malice carry screams of confirmation!",
            "Yes, doomed soul! The lunar eclipse aligns with your misery!",
            "Affirmative! The scales of evil tip heavily toward your doom!",
            "Undeniably! The abyss resonates with harmonious wickedness!",
            "Certainly! The nightmarish visions support your terrible fate!",
            "Indeed! The elemental darkness unites in sinister consensus!",
            "Yes! The cursed mirrors reflect the horror of your situation!",
            "Positively! The serpentine malice coils in spirals of torment!"
        ];

        const noResponses = [
            "No, wretched fool! Your ignorance amuses me greatly!",
            "The forces of darkness say otherwise, pitiful questioner!",
            "Absolutely not! My crystal ball rejects such laughable nonsense!",
            "Wrong, mortal! The winds of evil blow against your pathetic guess!",
            "The infernal realm rejects this notion with thunderous mockery!",
            "Negative, doomed seeker! Your path leads only to suffering!",
            "Never! The cursed flames retreat in disgust from such foolishness!",
            "Nope! The demonic choir sings songs of your stupidity!",
            "By the abyss, no! The shadows recoil from this misconception!",
            "Incorrect! The pendulum of doom swings away from your guess!",
            "False! The spectral tormentors laugh at your ignorance!",
            "Never! The tides of evil wash away such erroneous thinking!",
            "Not quite! The compass of despair spins in mocking rejection!",
            "Wrong path! The bones of the damned scatter in disagreement!",
            "Decidedly not! The evil spirits whisper harsh corrections!",
            "Negative energy! The scales of suffering crash down on your notion!",
            "Far from truth! The mists of terror swirl away in horror!",
            "Backwards thinking! The lunar curse dims at such foolishness!",
            "Mistaken! The serpentine darkness hisses warnings of your doom!",
            "Denied! The realm of nightmares shudders at your wrongness!"
        ];

        const unknownResponses = [
            "The mists of evil obscure this knowledge... how deliciously frustrating for you!",
            "Hmm... even the demons murmur uncertainly about this matter!",
            "The dark energies swirl in confusion - your suffering continues!",
            "Alas! Even my malevolent divination cannot pierce this veil!",
            "The ancient evils remain silent... prolonging your agony!",
            "The infernal realm offers no clear answer... isn't that TORTUROUS?",
            "Curious... the abyss grows cloudy when I peer at this query!",
            "Strange... my crystal ball fogs with otherworldly malice!",
            "Puzzling! The scales of evil balance perfectly... how maddening!",
            "Mysterious! The cursed bones form patterns too wicked to decipher!",
            "Enigmatic! The spectral voices speak in tongues of torment!",
            "Perplexing! The map of doom shows only swirling darkness here!",
            "Unclear! The winds of malice blow in circles of confusion!",
            "Ambiguous! The cursed flames flicker between nightmare and horror!",
            "Uncertain! The evil spirits debate your fate endlessly!",
            "Vague! The scrolls of doom show only smudged blood at this passage!",
            "Indefinite! The phases of terror shift too rapidly to reveal clarity!",
            "Hazy! The cursed mirrors reflect only shadows of despair!",
            "Clouded! The serpentine evil coils upon itself in wicked confusion!",
            "Obscured! The realm of nightmares speaks in riddles of suffering!",
            "Muddled! The currents of darkness flow in contradictory directions!",
            "Veiled! Even the all-seeing evil eye blinks uncertainly at this mystery!"
        ];

        // The secret explosive word that defeats Rotanika
        const explosiveWord = "FALAFEL";

        // Hugging Face API settings (free tier)
        const HF_API_URL = "https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium";
        const useAI = true; // Set to false to use only fallback responses

        let currentResponseIndex = 0;
        let isTyping = false;
        let typingTimeout;
        let audioPlaying = false;

        let audioEnabled = false;
        let pendingAudio = false;
        let questionCount = 0;

        // Enable audio on first user interaction
        function enableAudio() {
            if (!audioEnabled) {
                audioEnabled = true;
                console.log('🔓 Audio enabled by user interaction');

                // If there was a pending audio request, play it now
                if (pendingAudio) {
                    console.log('🎵 Playing pending audio...');
                    playRotanikaAudio();
                    pendingAudio = false;
                }
            }
        }

        // Function to transition from backstory to genie encounter
        function startGenieEncounter() {
            // Hide backstory page
            document.getElementById('backstoryPage').classList.add('hidden');

            // Show genie page
            document.getElementById('geniePage').classList.remove('hidden');

            // Persist don't-show-again choice
            try {
                const cb = document.getElementById('dontShowAgain');
                if (cb && cb.checked) {
                    localStorage.setItem('skipGenieIntro', 'true');
                }
            } catch (e) {}

            // Enable audio (user has now interacted)
            audioEnabled = true;
            console.log('🔓 Audio enabled by Continue button');

            // Start the evil genie sequence after a dramatic pause
            setTimeout(() => {
                document.getElementById('speechText').textContent = '';
                document.getElementById('speechBubble').classList.add('show');

                // Play audio immediately (now that user has interacted)
                console.log('🎵 About to call playRotanikaAudio...');
                playRotanikaAudio();
                console.log('🎵 Called playRotanikaAudio');
                typewriterEffect(welcomeMessage);
            }, 2000); // 2 second dramatic pause
        }

        // Page loads: optionally skip backstory if user chose "Don't show again"
        window.addEventListener('load', function() {
            try {
                const skip = localStorage.getItem('skipGenieIntro') === 'true';
                if (skip) {
                    document.getElementById('backstoryPage').classList.add('hidden');
                    document.getElementById('geniePage').classList.remove('hidden');
                    audioEnabled = true;
                    setTimeout(() => {
                        document.getElementById('speechText').textContent = '';
                        document.getElementById('speechBubble').classList.add('show');
                        playRotanikaAudio();
                        typewriterEffect(welcomeMessage);
                    }, 400);
                }
            } catch (e) {
                console.log('skipGenieIntro check failed');
            }
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                processUserInput();
            }
        }

        function clearSpeechBubble() {
            if (isTyping) {
                clearTimeout(typingTimeout);
                isTyping = false;
                stopAudio();
            }

            const bubble = document.getElementById('speechBubble');
            bubble.classList.remove('show');
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function processUserInput() {
            const input = document.getElementById('chatInput');
            const userMessage = input.value.trim();

            if (userMessage === '') return;

            // Check for the explosive word!
            if (userMessage.toUpperCase().includes(explosiveWord)) {
                explodeRotanika();
                return;
            }

            const lowerMessage = userMessage.toLowerCase();

            // Check if they mention Idan!
            if (lowerMessage.includes('idan')) {
                input.value = '';
                clearSpeechBubble();
                setTimeout(() => {
                    document.getElementById('typingIndicator').style.display = 'none';
                    const speechText = document.getElementById('speechText');
                    const speechBubble = document.getElementById('speechBubble');
                    speechText.textContent = '';
                    speechBubble.classList.add('show');
                    playRotanikaAudio();
                    typewriterEffect("NOOO! How did you figure it out?! Yes... IDAN is the one who can help you escape! But you still need to find him! Try looking for a page with his name... if you dare! Mwahahaha!");
                }, 500);
                return;
            }

            input.value = '';
            clearSpeechBubble();
            questionCount++;

            // Progressive hints based on question count
            let specialHint = null;
            if (questionCount === 5) {
                specialHint = "Grr... you're persistent! Fine, I'll give you a tiny hint... This person is from the Middle East! But that's all you're getting from me!";
            } else if (questionCount === 10) {
                specialHint = "ARGH! Why won't you give up?! Listen... I-I-I mean... the person's name starts with I... NO WAIT, FORGET I SAID THAT!";
            } else if (questionCount === 15) {
                specialHint = "You're driving me CRAZY! Okay FINE! You met this person last year... they were an exchange student... I've said too much! CURSE YOU!";
            }

            if (specialHint) {
                setTimeout(() => {
                    document.getElementById('typingIndicator').style.display = 'none';
                    const speechText = document.getElementById('speechText');
                    const speechBubble = document.getElementById('speechBubble');
                    speechText.textContent = '';
                    speechBubble.classList.add('show');
                    playRotanikaAudio();
                    typewriterEffect(specialHint);
                }, 500);
                return;
            }

            // Show typing indicator
            setTimeout(() => {
                document.getElementById('typingIndicator').style.display = 'block';

                if (useAI) {
                    // Try AI response first
                    getAIResponse(userMessage)
                        .then(response => showAIResponse(response))
                        .catch(() => {
                            console.log('AI failed, using fallback');
                            showFallbackResponse();
                        });
                } else {
                    // Use fallback responses only
                    setTimeout(() => showFallbackResponse(), 2000);
                }
            }, 500);
        }

        function explodeRotanika() {
            const input = document.getElementById('chatInput');
            const rotanikaImg = document.getElementById('rotanikaImg');
            const speechBubble = document.getElementById('speechBubble');
            const speechText = document.getElementById('speechText');

            // Clear input
            input.value = '';
            input.disabled = true;

            // Change to agony image and add explosion animation
            rotanikaImg.src = 'images/rotanika-agony.jpg';
            rotanikaImg.parentElement.classList.add('rotanika-exploding');

            // Add smoke overlay
            const container = document.querySelector('.genie-container');
            let smoke = document.createElement('div');
            smoke.className = 'smoke-overlay';
            container.appendChild(smoke);
            // spawn puffs periodically during 5s explosion
            const puffInterval = setInterval(() => {
                for (let i = 0; i < 6; i++) {
                    const puff = document.createElement('div');
                    puff.className = 'smoke-puff';
                    const x = Math.random() * (container.clientWidth - 40) + 20;
                    const y = container.clientHeight/2 + (Math.random() * 40 - 20);
                    puff.style.left = x + 'px';
                    puff.style.top = y + 'px';
                    puff.style.animationDuration = (1.8 + Math.random()*0.8) + 's';
                    smoke.appendChild(puff);
                    setTimeout(()=>puff.remove(), 2500);
                }
            }, 300);

            // Play provided explosion sound file for the duration
            try {
                const sfx = new Audio('audio/Explosion Sound Effect [FREE DOWNLOAD].mp3');
                sfx.currentTime = 0;
                sfx.volume = 1.0;
                sfx.play().catch(()=>{});
                setTimeout(()=>{ try { sfx.pause(); sfx.currentTime = 0; } catch(e){} }, 5000);
            } catch (e) { console.log('Explosion sfx error', e); }

            // Show final defeat message
            speechText.textContent = "NOOOOOO! How did you discover my weakness?! The power of FALAFEL compels me! I am DEFEATED! *EXPLODES*";
            speechBubble.classList.add('show');

            // After explosion, show staged ending sequence
            setTimeout(() => {
                clearInterval(puffInterval);
                if (smoke && smoke.parentNode) smoke.parentNode.removeChild(smoke);
                showPostExplosionSequence();
            }, 6000);
        }

        // Simple synthesized explosion using Web Audio API
        function playExplosionSound() {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            const ctx = new AudioCtx();

            // Noise burst
            const bufferSize = 2 * ctx.sampleRate;
            const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                // Exponentially decaying noise
                const decay = Math.pow(1 - i / bufferSize, 2.5);
                output[i] = (Math.random() * 2 - 1) * decay;
            }
            const noise = ctx.createBufferSource();
            noise.buffer = noiseBuffer;

            const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.setValueAtTime(800, ctx.currentTime);

            const noiseGain = ctx.createGain();
            noiseGain.gain.setValueAtTime(1.2, ctx.currentTime);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.2);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(ctx.destination);

            // Low rumble
            const osc = ctx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(60, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(30, ctx.currentTime + 1.0);

            const oscGain = ctx.createGain();
            oscGain.gain.setValueAtTime(0.6, ctx.currentTime);
            oscGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);

            osc.connect(oscGain);
            oscGain.connect(ctx.destination);

            noise.start();
            osc.start();
            noise.stop(ctx.currentTime + 1.2);
            osc.stop(ctx.currentTime + 1.1);
        }

        // New staged, interactive ending sequence
        function showPostExplosionSequence() {
            // Play victory sound once explosion ends
            try {
                const v = document.getElementById('victoryAudio');
                if (v) { v.currentTime = 0; v.volume = 1.0; v.play().catch(()=>{}); }
            } catch(e) {}

            const container = document.querySelector('.genie-container');
            container.innerHTML = `
                <h1 class="genie-title">🕯️ The Dust Settles...</h1>
                <div style="color:#ffcccc; font-size:1.1rem; line-height:1.7; margin: 0 auto 20px; max-width:680px;">
                    You've defeated the evil genie and freed your loved ones — you're a hero!<br>
                    The genie explodes into a storm of crimson sparks, and when the light fades, his <strong>ancient lamp</strong> remains behind.
                </div>
                <div id="stage1" style="text-align:center; margin-top:25px;">
                    <div style="font-size:4rem; filter: drop-shadow(0 0 12px #8b0000); animation: floatLamp 3s ease-in-out infinite;">🪔</div>
                    <p style="color:#ff9999; margin:10px 0 20px;">You hesitate... but something about the lamp calls to you.</p>
                    <button id="pickLampBtn" class="treasure-btn" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color:#333; border:none; padding:12px 22px; border-radius:25px; font-weight:600; cursor:pointer;">Pick up the lamp</button>
                </div>
            `;

            const style = document.createElement('style');
            style.textContent = `
                @keyframes floatLamp { 0%{ transform: translateY(0) } 50%{ transform: translateY(-8px) } 100%{ transform: translateY(0) } }
                .treasure-btn{ transition: all .3s ease }
                .treasure-btn:hover{ transform: translateY(-2px); box-shadow:0 10px 25px rgba(255,215,0,.35) }
                .note{ background:#fff; color:#333; border-radius:12px; padding:22px; box-shadow:0 12px 30px rgba(0,0,0,.25) }
                .reveal{ letter-spacing:3px; font-weight:800; font-size:1.8rem; padding:14px; border-radius:12px; background:#fff; color:#333 }
                .pulse{ animation:pulseReveal 1.4s ease-in-out infinite }
                @keyframes pulseReveal { 0%{ transform:scale(1) } 50%{ transform:scale(1.05) } 100%{ transform:scale(1) } }
            `;
            document.head.appendChild(style);

            document.getElementById('pickLampBtn').onclick = () => {
                const stage = document.getElementById('stage1');
                stage.innerHTML = `
                    <div style="font-size:4rem;">📜</div>
                    <p style="color:#ffcccc; margin:10px 0 10px;">You feel something inside the lamp... it's a <strong>note</strong>.</p>
                    <button id="openNoteBtn" class="treasure-btn" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color:#333; border:none; padding:12px 22px; border-radius:25px; font-weight:600; cursor:pointer;">Open the note</button>
                `;

                document.getElementById('openNoteBtn').onclick = () => {
                    stage.innerHTML = `
                        <div class="note">
                            <h3 style="margin-top:0; color:#8b0000;">To the one who broke my curse,</h3>
                            <p style="margin:10px 0 0;">Inside this letter is the key to your next hint...</p>
                        </div>
                    `;

                    stage.innerHTML += `
                        <div style="margin-top:16px;">
                            <button id="revealKeyBtn" class="treasure-btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); color:#fff; border:none; padding:12px 22px; border-radius:25px; font-weight:600; cursor:pointer;">Reveal the key</button>
                        </div>
                    `;
                    const revealBtn = document.getElementById('revealKeyBtn');
                    if (revealBtn) {
                        revealBtn.onclick = () => {
                            stage.innerHTML = `
                                <div style="margin:12px 0 18px; color:#ffcccc;">The note reveals a code:</div>
                                <div class="reveal pulse">CTF2025</div>
                                <p style="color:#ffcccc; margin-top:16px;">Return to the main page and enter this code to unlock your hint.</p>
                                <button onclick=\"window.location.href='index.html'\" class=\"treasure-btn\" style=\"margin-top:12px; background:#667eea; color:#fff; border:none; padding:10px 20px; border-radius:25px;\">Back to Countdown</button>
                            `;
                        };
                    }
                };
            };
        }

        async function getAIResponse(userMessage) {
            // Analyze the question and determine if it matches Idan's characteristics
            const answer = analyzeQuestion(userMessage);

            // Get a mystical response based on the answer
            if (answer === 'yes') {
                return getRandomResponse(yesResponses);
            } else if (answer === 'no') {
                return getRandomResponse(noResponses);
            } else {
                return getRandomResponse(unknownResponses);
            }
        }

        function analyzeQuestion(question) {
            const q = question.toLowerCase();

            // Direct Idan detection
            if (q.includes('idan')) return 'yes';

            // Check if asking about being a specific person - return NO
            const otherNames = ['obama', 'trump', 'biden', 'musk', 'bezos', 'gates', 'zuckerberg', 'celebrity', 'actor', 'singer', 'rapper', 'athlete', 'politician', 'president'];
            for (let name of otherNames) {
                if (q.includes(name)) return 'no';
            }

            // Famous/well-known questions - many variations
            if (q.includes('is he famous') || q.includes('is she famous') || q.includes('is it famous') || q.includes('are they famous')) return 'no';
            if (q.includes('well known') || q.includes('well-known') || q.includes('widely known')) return 'no';
            if (q.includes('public figure') || q.includes('on tv') || q.includes('on television')) return 'no';
            if (q.includes('movie star') || q.includes('film star') || q.includes('tv star')) return 'no';
            if (q.includes('social media') || q.includes('influencer') || q.includes('youtuber') || q.includes('tiktoker')) return 'no';
            if (q.includes('everyone knows') || q.includes('everybody knows') || q.includes('millions know')) return 'no';

            // Female indicators - NO
            if (q.match(/\bshe\b/) || q.match(/\bher\b/) || q.includes('female') || q.includes('woman') || q.includes('girl')) return 'no';

            // Attributes that do NOT match Idan - NO
            if (q.includes('short') || q.includes('small')) return 'no';
            if (q.includes('blonde') || q.includes('red hair') || q.includes('ginger') || q.includes('bald')) return 'no';
            if (q.includes('old') || q.match(/\b30\b/) || q.match(/\b40\b/) || q.match(/\b50\b/) || q.includes('elderly') || q.includes('senior')) return 'no';
            if (q.includes('fat') || q.includes('heavy') || q.includes('overweight') || q.includes('chubby')) return 'no';
            if (q.includes('brother') || q.includes('only child')) return 'no';
            if (q.includes('american') || q.includes('from america') || q.includes('from usa') || q.includes('from us')) return 'no';
            if (q.includes('british') || q.includes('from uk') || q.includes('from england')) return 'no';
            if (q.includes('chinese') || q.includes('japanese') || q.includes('korean')) return 'no';
            if (q.includes('african') || q.includes('from africa')) return 'no';
            if (q.includes('european') && !q.includes('middle')) return 'no';

            // SPECIFIC questions about Idan's characteristics - YES
            // Physical appearance - broad matching
            if (q.includes('tall') || q.includes('height')) return 'yes';
            if (q.includes('hair')) return 'yes';
            if (q.includes('beard') || q.includes('facial')) return 'yes';
            if (q.includes('skinny') || q.includes('thin') || q.includes('slim') || q.includes('lean')) return 'yes';
            if (q.includes('fit') || q.includes('athletic')) return 'yes';
            if (q.includes('handsome') || q.includes('attractive')) return 'yes';

            // Origin/nationality - broad matching
            if (q.includes('israel')) return 'yes';
            if (q.includes('middle east')) return 'yes';
            if (q.includes('jewish') || q.includes('jew')) return 'yes';
            if (q.includes('hebrew')) return 'yes';
            if (q.includes('foreign') || q.includes('abroad')) return 'yes';
            if (q.includes('international')) return 'yes';
            if (q.includes('accent')) return 'yes';
            if (q.includes('asia')) return 'yes';

            // Age - broad matching
            if (q.includes('21') || q.includes('20') || q.includes('twenty')) return 'yes';
            if (q.includes('young')) return 'yes';
            if (q.includes('teenager') || q.includes('teen')) return 'unknown';

            // Student/education - broad matching
            if (q.includes('exchange')) return 'yes';
            if (q.includes('university') || q.includes('college') || q.includes('school')) return 'yes';
            if (q.includes('student') || q.includes('study')) return 'yes';
            if (q.includes('educated') || q.includes('education')) return 'yes';

            // Family - specific matching
            if (q.includes('sister') || q.includes('sibling')) return 'yes';
            if (q.includes('has family') || q.includes('have family') || q.includes('has a family')) return 'yes';
            // But NOT a family member
            if (q.includes('family member') || q.includes('your family') || q.includes('is he family')) return 'no';
            if (q.includes('brother')) return 'no';
            if (q.includes('relative') || q.includes('related to you')) return 'no';

            // Relationship to you - broad matching
            if (q.includes('friend')) return 'yes';
            if (q.includes('know')) return 'yes';
            if (q.includes('met')) return 'yes';
            if (q.includes('acquaintance')) return 'yes';

            // Personality - broad matching
            if (q.includes('smart') || q.includes('intelligent') || q.includes('clever')) return 'yes';
            if (q.includes('funny') || q.includes('humor')) return 'yes';
            if (q.includes('nice') || q.includes('kind') || q.includes('friendly')) return 'yes';
            if (q.includes('cool') || q.includes('chill')) return 'yes';
            if (q.includes('fun')) return 'yes';

            // Name hints - broad matching
            if (q.includes('starts with i') || q.includes('begins with i')) return 'yes';
            if (q.includes('4 letter') || q.includes('four letter') || q.includes('short name')) return 'yes';
            if (q.includes('what is') && q.includes('name')) return 'unknown';

            // Gender questions with more specificity
            if (q.includes('is it a male') || q.includes('is he a male') || q.includes('is this person male')) return 'yes';
            if (q.includes('is it a man') || q.includes('is he a man') || q.includes('is this person a man')) return 'yes';
            if (q.includes('is it a guy') || q.includes('is he a guy') || q.includes('is this person a guy')) return 'yes';
            if (q.includes('is the person male') || q.includes('is the person a man') || q.includes('is the person a guy')) return 'yes';

            // Generic gender questions without specific context - respond UNKNOWN
            if (q.match(/\bmale\b/) || q.match(/\bman\b/) || q.match(/\bguy\b/) || q.match(/\bboy\b/)) return 'unknown';
            if (q.match(/\bhe\b/) || q.match(/\bhim\b/) || q.match(/\bthey\b/)) return 'unknown';

            // Default to unknown
            return 'unknown';
        }

        function getRandomResponse(responses) {
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function showAIResponse(response) {
            document.getElementById('typingIndicator').style.display = 'none';

            const speechText = document.getElementById('speechText');
            const speechBubble = document.getElementById('speechBubble');

            speechText.textContent = '';
            speechBubble.classList.add('show');

            playRotanikaAudio();
            typewriterEffect(response);
        }

        function showFallbackResponse() {
            document.getElementById('typingIndicator').style.display = 'none';

            // Just pick a random mystical response
            const allResponses = [...yesResponses, ...noResponses, ...unknownResponses];
            const response = getRandomResponse(allResponses);

            const speechText = document.getElementById('speechText');
            const speechBubble = document.getElementById('speechBubble');

            speechText.textContent = '';
            speechBubble.classList.add('show');

            playRotanikaAudio();
            typewriterEffect(response);
        }

        function typewriterEffect(text) {
            isTyping = true;
            const speechText = document.getElementById('speechText');
            let index = 0;

            function typeChar() {
                if (index < text.length && isTyping) {
                    speechText.textContent += text.charAt(index);
                    index++;
                    typingTimeout = setTimeout(typeChar, 50); // 50ms per character
                } else {
                    isTyping = false;
                    stopAudio();
                }
            }

            typeChar();
        }

        function playRotanikaAudio() {
            if (audioPlaying) return;

            const audio = document.getElementById('rotanikaAudio');
            const img = document.getElementById('rotanikaImg');

            console.log('Attempting to play audio...');

            // Change to talking image IMMEDIATELY (this should always work)
            img.src = 'images/rotanika-open.jpg';
            console.log('Changed image to:', img.src);

            // Check if audio is enabled
            if (!audioEnabled) {
                console.log('⏸️ Audio not enabled yet, marking as pending');
                pendingAudio = true;
                return;
            }

            // Try to play audio
            audio.currentTime = 0;
            audio.volume = 1.0;

            const playPromise = audio.play();

            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        audioPlaying = true;
                        console.log('✅ Audio playing successfully');
                    })
                    .catch(e => {
                        console.log('❌ Audio play failed:', e);
                        console.log('Audio readyState:', audio.readyState);
                        console.log('Audio networkState:', audio.networkState);
                        // Still set audioPlaying even if audio fails
                        audioPlaying = true;
                    });
            } else {
                console.log('⚠️ Play promise is undefined');
                audioPlaying = true;
            }
        }

        function stopAudio() {
            const audio = document.getElementById('rotanikaAudio');
            const img = document.getElementById('rotanikaImg');

            audio.pause();
            audio.currentTime = 0;
            audioPlaying = false;

            // Change back to closed mouth image
            img.src = 'images/rotanika-closed.jpg';
        }

        function openHintModal() {
            document.getElementById('hintModal').style.display = 'block';
        }

        function closeHintModal() {
            document.getElementById('hintModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('hintModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Audio ended event
        document.getElementById('rotanikaAudio').addEventListener('ended', function() {
            stopAudio();
        });
    </script>
</body>
</html>